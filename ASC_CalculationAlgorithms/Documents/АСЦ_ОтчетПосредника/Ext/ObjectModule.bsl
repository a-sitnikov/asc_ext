#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ
//

Процедура ДобавитьИзменениеОбъекта(ДокументСсылка, База)
	
	Если НЕ ЗначениеЗаполнено(База) Тогда
		Возврат;
	КонецЕсли;	
	
	Запись = РегистрыСведений.ИзмененныеОбъектыДляВыгрузки.СоздатьМенеджерЗаписи();
	Запись.ИспользуемаяИБ        = База;
	Запись.НастройкаСоответствия = "";
	Запись.Элемент               = ДокументСсылка;
	
	Запись.Записать();
	
КонецПроцедуры	

Процедура ЗаписатьДокумент(ДокументОбъект)
	
	Если ДокументОбъект = Неопределено Тогда
		Возврат;
	КонецЕсли;	
	
	Режим = РежимЗаписиДокумента.Запись;
		
	НачатьТранзакцию();
		
	ДокументОбъект.Записать(Режим);
	
	Запись = РегистрыСведений.ОтложенныеДвиженияДокументов.СоздатьМенеджерЗаписи();
	Запись.Документ      = ДокументОбъект.Ссылка;
	Запись.УзелОбмена    = ПланыОбмена.Полный.ЭтотУзел();
	Запись.ДатаДокумента = ДокументОбъект.Дата;
	Запись.Записать();
		
	ЗафиксироватьТранзакцию();
	
КонецПроцедуры	

Функция ПолучитьДанныеДокумента(ДокументСсылка)
	
	Запрос = Новый Запрос;
	Запрос.Параметры.Вставить("Ссылка", ДокументСсылка);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Док.Дата КАК Дата,
	|	ЕСТЬNULL(ДокУслуги.Номенклатура, ДокАгентскиеУслуги.Номенклатура) КАК Номенклатура,
	|	Док.СуммаДокумента КАК Сумма,
	|	ДокАгентскиеУслуги.ДоговорКонтрагента КАК ДоговорСК,
	|	ЕСТЬNULL(ДокАгентскиеУслуги.Сумма, 0) КАК СуммаАгенскиеУслуги,
	|	ЕСТЬNULL(ДокУслуги.Сумма, 0) КАК СуммаУслуги
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК Док
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Услуги КАК ДокУслуги
	|		ПО (ДокУслуги.Ссылка = Док.Ссылка)
	|			И (ДокУслуги.НомерСтроки = 1)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.АгентскиеУслуги КАК ДокАгентскиеУслуги
	|		ПО (ДокАгентскиеУслуги.Ссылка = Док.Ссылка)
	|			И (ДокАгентскиеУслуги.НомерСтроки = 1)
	|ГДЕ
	|	Док.Ссылка = &Ссылка";
	
	ДокументИмя = ДокументСсылка.Метаданные().Имя;
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "РеализацияТоваровУслуг", ДокументИмя); 
	
	Возврат Запрос.Выполнить().Выгрузить()[0];
	
КонецФункции	

// Функция проверяет соотвествие документа и данным строки
// Ворзвращаемое занчение: 
//    Истина - Документ соотвествует строке, перезаполнять не нужно
//    Ложь   - Документ не соответствует строке
Функция ДокументРТУСоответствуетСтроке(ДанныеДокумента, СтрокаТЧ)
	
	Если ДанныеДокумента.Сумма <> СтрокаТЧ.СуммаОплаты
		ИЛИ ДанныеДокумента.СуммаУслуги <> СтрокаТЧ.СуммаКВ Тогда
		
		Возврат Ложь;
		
	Иначе	
		
		Возврат Истина;
		
	КонецЕсли;	
	
КонецФункции	

Процедура ЗаполнитьДокументыПоСтроке(СтрокаТЧ) Экспорт
	
	Если Ложь Тогда
		СтрокаТЧ = Продажи.Добавить();
	КонецЕсли;	
	
	СвойствоID = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("Имя", "UNICUS_ID");
	ЭтоКорректировка = Ложь;
	
	Если НЕ ЗначениеЗаполнено(СтрокаТЧ.Документ) Тогда
		СтрокаТЧ.Документ = АСЦ_ПоискОбъектов.НайтиДокументПоСвойству(СтрокаТЧ.ID, СвойствоID, "РеализацияТоваровУслуг");
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(СтрокаТЧ.Документ) Тогда
		// Ненайден документ реализации ничего не делаем
		Сообщить("Не найден документ реализации для договора " + СтрокаТЧ.ДоговорКонтрагента + ", ID: " + СтрокаТЧ.id);
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СтрокаТЧ.Корректировка) Тогда
		СтрокаТЧ.Корректировка = АСЦ_ПоискОбъектов.НайтиДокументКорректировки(СтрокаТЧ.Документ);
	КонецЕсли;	
		
	ДанныеДокументаРТУ = ПолучитьДанныеДокумента(СтрокаТЧ.Документ);
	
	// Установим договор со страховой
	Если СтрокаТЧ.СуммаОплаты - СтрокаТЧ.СуммаКВ > 0 Тогда 
		
		Если ДанныеДокументаРТУ.ДоговорСК <> ДоговорКонтрагента Тогда
			
			ДокументОбъект = СтрокаТЧ.Документ.ПолучитьОбъект();
			ДокументОбъект.АгентскиеУслуги[0].ДоговорКонтрагента = ДоговорКонтрагента;
			ЗаписатьДокумент(ДокументОбъект);
			
		КонецЕсли;
		
	КонецЕсли;	
	
	// Проверим суммы. Если совпадают, то корректировку делать не нужно
	Если ДанныеДокументаРТУ.СуммаАгенскиеУслуги = СтрокаТЧ.СуммаОплаты - СтрокаТЧ.СуммаКВ
		ИЛИ ДанныеДокументаРТУ.СуммаУслуги = СтрокаТЧ.СуммаКВ Тогда
		Возврат;
	КонецЕсли;	
	
	Если ЗначениеЗаполнено(СтрокаТЧ.Корректировка) Тогда
		
		ДанныеДокументаКорр = ПолучитьДанныеДокумента(СтрокаТЧ.Корректировка);
		
		// Корректировка уже сформирована, исправлять не нужно
		Если ДанныеДокументаКорр.СуммаАгенскиеУслуги = СтрокаТЧ.СуммаОплаты - СтрокаТЧ.СуммаКВ
			ИЛИ ДанныеДокументаКорр.СуммаУслуги = СтрокаТЧ.СуммаКВ Тогда
			Возврат;
		Иначе	
			//Нужно отредактировать корректировку
			ДокументОбъект = СтрокаТЧ.Корректировка.ПолучитьОбъект();
		КонецЕсли;	
		
	Иначе	
		ДокументОбъект = Документы.КорректировкаРеализации.СоздатьДокумент();
	КонецЕсли;	
	
	ВремяДокумента = Документы.КорректировкаРеализации.ВремяДокументаПоУмолчанию();
	
	ДокументОбъект.ПометкаУдаления = Ложь;
	ДокументОбъект.Дата            = НачалоДня(ДанныеДокументаРТУ.Дата) + ВремяДокумента.Часы * 3600 + ВремяДокумента.Минуты * 60;
	ДокументОбъект.Заполнить(СтрокаТЧ.Документ);
	
	Если ДокументОбъект.Услуги.Количество() = 1 Тогда
		НоваяСтрока = ДокументОбъект.Услуги[0];
		НоваяСтрока.Сумма = СтрокаТЧ.СуммаКВ;
	Иначе
	КонецЕсли;	
	
	Если ДокументОбъект.АгентскиеУслуги.Количество() = 1 Тогда
		НоваяСтрока = ДокументОбъект.АгентскиеУслуги[0];
		НоваяСтрока.Сумма = СтрокаТЧ.СуммаОплаты - СтрокаТЧ.СуммаКВ;
	Иначе	
	КонецЕсли;
	
	НачатьТранзакцию();
	
	ЗаписатьДокумент(ДокументОбъект);
	
	База = АСЦ_ПоискОбъектов.ПолучитьОсновнуюБазу(ДокументОбъект.ДоговорКонтрагента.ОсновнойЦФО);
	ДобавитьИзменениеОбъекта(ДокументОбъект.Ссылка, База);

	ЗафиксироватьТранзакцию();
	
	СтрокаТЧ.Корректировка = ДокументОбъект.Ссылка;
	
КонецПроцедуры

Функция ЗаполнитьОтчетКомитенту() Экспорт
	
	Если НЕ ЗначениеЗаполнено(ОтчетКомитентуОПродажах) Тогда
		СвойствоID = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("Имя", "UNICUS_ID");
		ОтчетКомитентуОПродажах = АСЦ_ПоискОбъектов.НайтиДокументПоСвойству(ID_Unicus, СвойствоID, "ОтчетКомитентуОПродажах");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ОтчетКомитентуОПродажах) Тогда
		
		ДокументОбъект = ОтчетКомитентуОПродажах.ПолучитьОбъект();
		ДокументОбъект.Товары.Очистить();
		
	Иначе
		
		ДокументОбъект = Документы.ОтчетКомитентуОПродажах.СоздатьДокумент();
		
	КонецЕсли;	
	
	ДокументОбъект.ПометкаУдаления    = Ложь;

	ДокументОбъект.ВидОперации        = Перечисления.ВидыОперацийОтчетКомитентуОПродажах.ОтчетОПродажах;
	ДокументОбъект.Организация        = Организация;
	ДокументОбъект.Контрагент         = Контрагент;
	ДокументОбъект.ДоговорКонтрагента = ДоговорКонтрагента;
	ДокументОбъект.ВалютаДокумента    = ОбщегоНазначенияБПВызовСервераПовтИсп.ПолучитьВалютуРегламентированногоУчета();
	ДокументОбъект.Ответственный      = Пользователи.ТекущийПользователь();
	ДокументОбъект.ПодразделениеОрганизации = ПодразделениеОрганизации;
	ДокументОбъект.СпособРасчетаКомиссионногоВознаграждения = Перечисления.СпособыРасчетаКомиссионногоВознаграждения.НеРассчитывается;
	ДокументОбъект.СтавкаНДСВознаграждения  = Перечисления.СтавкиНДС.БезНДС;
	ДокументОбъект.СчетУчетаРасчетовСКонтрагентом = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.01.1");
	ДокументОбъект.СчетДоходов                    = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.01.1");
	
	Для каждого СтрокаТЧ из Продажи Цикл
		
		Если СтрокаТЧ.СуммаОплаты <> 0 Тогда
			
			ДанныеДокумента = ПолучитьДанныеДокумента(СтрокаТЧ.Документ);
			
			НоваяСтрока = ДокументОбъект.Товары.Добавить();
			НоваяСтрока.Номенклатура = ДанныеДокумента.Номенклатура;
			НоваяСтрока.Покупатель   = СтрокаТЧ.Контрагент;
			НоваяСтрока.Сумма        = СтрокаТЧ.СуммаОплаты;
			НоваяСтрока.СтавкаНДС    = Перечисления.СтавкиНДС.БезНДС;
			НоваяСтрока.ДатаРеализации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтрокаТЧ.Документ, "Дата");
			НоваяСтрока.КлючСтроки   = НоваяСтрока.НомерСтроки;
			
			ДокументОбъект.Дата      = Макс(ДокументОбъект.Дата, НоваяСтрока.ДатаРеализации);
			
		КонецЕсли;	
		
	КонецЦикла;	
	
	// Дата документа - максимальная дата реализации
	// дата документа в Юникус - это обычно начало месяца
	ВремяДокумента = Документы.ОтчетКомитентуОПродажах.ВремяДокументаПоУмолчанию();
	ДокументОбъект.Дата = НачалоДня(ДокументОбъект.Дата) + ВремяДокумента.Часы * 3600 + ВремяДокумента.Минуты * 60 + 5;
	
	НачатьТранзакцию();
	
	ЗаписатьДокумент(ДокументОбъект);
	
	Запись = РегистрыСведений.ДополнительныеСведения.СоздатьМенеджерЗаписи();
	Запись.Объект   = ДокументОбъект.Ссылка;
	Запись.Свойство = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("Имя", "ID_Unicus");
	Запись.Значение = ID_Unicus;
	Запись.Записать();
	
	ЗафиксироватьТранзакцию();
	
	ОтчетКомитентуОПродажах = ДокументОбъект.Ссылка;
	
	Возврат ДокументОбъект.Ссылка;
	
КонецФункции	

Процедура ЗаполнитьСвязанныеДокументы() Экспорт
	
	НачатьТранзакцию();
	
	Для каждого СтрокаТЧ из Продажи Цикл
		ЗаполнитьДокументыПоСтроке(СтрокаТЧ);
	КонецЦикла;	
		
	ЗаполнитьОтчетКомитенту();
	
	Записать();
	
	ЗафиксироватьТранзакцию();
	
КонецПроцедуры	

Процедура ПровестиСвязныеДокументы(РежимЗаписи = Неопределено, РежимПроведения = Неопределено) Экспорт
	
	Если РежимЗаписи = Неопределено Тогда 
		РежимЗаписи = РежимЗаписиДокумента.Проведение;
	КонецЕсли;
	
	Если РежимПроведения = Неопределено Тогда 
		РежимПроведения = РежимПроведенияДокумента.Неоперативный;
	КонецЕсли;	
	
	Для каждого СтрокаТЧ из Продажи Цикл
		
		Если НЕ ЗначениеЗаполнено(СтрокаТЧ.Корректировка) Тогда
			Продолжить;
		КонецЕсли;
		
		ДокументОбъект = СтрокаТЧ.Корректировка.ПолучитьОбъект();
		ДокументОбъект.Записать(РежимЗаписи, РежимПроведения);
		
	КонецЦикла;	
	
	Если ЗначениеЗаполнено(ОтчетКомитентуОПродажах) Тогда
		ДокументОбъект = ОтчетКомитентуОПродажах.ПолучитьОбъект();
		ДокументОбъект.Записать(РежимЗаписи, РежимПроведения);
	КонецЕсли;	
	
КонецПроцедуры	

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ
//

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	// Если не ведется учет по договорам и заполнен договор, 
	// то по реквизитам этого договора ищем основной договор
	// Если находим, то устанавливаем основной договор в качестве договора контрагента в документе.
	// В случае если не находим, то устанавливаем договор, который выбрал пользователь, как основной. 
	Если НЕ ПолучитьФункциональнуюОпцию("ВестиУчетПоДоговорам") И ЗначениеЗаполнено(ДоговорКонтрагента) Тогда
		СтруктураРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДоговорКонтрагента, "Организация, Владелец, ВидДоговора");
		
		ОсновнойДоговор = Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
		РаботаСДоговорамиКонтрагентовБП.УстановитьДоговорКонтрагента(
			ОсновнойДоговор, 
			СтруктураРеквизитов.Владелец,
			СтруктураРеквизитов.Организация,
			СтруктураРеквизитов.ВидДоговора);
			
		Если ЗначениеЗаполнено(ОсновнойДоговор) Тогда
			ДоговорКонтрагента = ОсновнойДоговор;
		Иначе
			РаботаСДоговорамиКонтрагентовБП.УстановитьОсновнойДоговорКонтрагента(ДоговорКонтрагента);
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)

	ЗаполнениеДокументов.Заполнить(ЭтотОбъект, ДанныеЗаполнения);

КонецПроцедуры

Процедура ПриКопировании(ОбъектКопирования)

	Дата = НачалоДня(ОбщегоНазначения.ТекущаяДатаПользователя());

КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	//ПровестиСвязныеДокументы(РежимЗаписиДокумента.Проведение, РежимПроведения);
	
КонецПроцедуры

Процедура ОбработкаУдаленияПроведения(Отказ)
	
	//ПровестиСвязныеДокументы(РежимЗаписиДокумента.ОтменаПроведения);
	
КонецПроцедуры

#КонецЕсли
