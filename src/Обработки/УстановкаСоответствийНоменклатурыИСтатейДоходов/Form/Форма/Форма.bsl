
&НаКлиенте
Процедура Прочитать(Команда)
	ПрочитатьНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПрочитатьНаСервере()
	
	Запрос = Новый Запрос;
	Запрос.Параметры.Вставить("Родитель", Справочники.Номенклатура.НайтиПоНаименованию("Страховки"));
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Номенклатура.Наименование КАК Наименование
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Родитель = &Родитель";
	
	ТаблицаДанных.Загрузить(Запрос.Выполнить().Выгрузить());
	
	Кэш = Новый Соответствие;
	Для каждого СтрокаТЗ из ТаблицаДанных Цикл
		СтрокаТЗ.Статья = АСЦ_ПоискОбъектов.ПолучитьОбъектПоСоотвествию(СтрокаТЗ.Наименование, Объект.Настройка, Объект.База, Кэш);
	КонецЦикла;	
	
	Элементы.ТаблицаДанныхЗаписать.КнопкаПоУмолчанию = Истина;
	
КонецПроцедуры

&НаКлиенте
Процедура Записать(Команда)
	
	Если Не ПроверитьЗаполнение() Тогда
		Возврат;
	КонецЕсли;	
	
	ЗаписатьНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ЗаписатьНаСервере()
	
	Свойство = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("Имя", "НаименованиеUNICUS");
	
	Для каждого СтрокаТЗ из ТаблицаДанных Цикл
		
		Если НЕ СтрокаТЗ.Изменен Тогда
			Продолжить;
		КонецЕсли;	
		
		Если НЕ ЗначениеЗаполнено(СтрокаТЗ.Статья) Тогда
			Продолжить;
		КонецЕсли;	
		
		НаборЗаписей = РегистрыСведений.СоответствиеОбъектовТекущейИВнешнихИБ.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.ИспользуемаяИБ.Установить(Объект.База, Истина);
		НаборЗаписей.Отбор.ОбъектВнешнейИБ.Установить(СтрокаТЗ.Наименование, Истина);
		НаборЗаписей.Отбор.НастройкаСоответствия.Установить(Объект.Настройка, Истина);
		
		Запись = НаборЗаписей.Добавить();
		Запись.ОбъектТекущейИБ = СтрокаТЗ.Статья;
		Запись.ИспользуемаяИБ  = Объект.База;
		Запись.ОбъектВнешнейИБ = СтрокаТЗ.Наименование;
		Запись.НастройкаСоответствия = Объект.Настройка;
		
		НаборЗаписей.Записать();
		
		СтрокаТЗ.Изменен = Ложь;
		
	КонецЦикла;	
	
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаДанныхОрганизацияПриИзменении(Элемент)
	
	Элементы.ТаблицаДанных.ТекущиеДанные.Изменен = Истина;
	
КонецПроцедуры

&НаСервере
Процедура БазаПриИзмененииНаСервере()
	
	Объект.ТипБазы = Объект.База.ТипБД;
	
КонецПроцедуры

&НаКлиенте
Процедура БазаПриИзменении(Элемент)
	БазаПриИзмененииНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Объект.База = Справочники.ВнешниеИнформационныеБазы.НайтиПоНаименованию("Юникус");
	Объект.Настройка = Справочники.СоответствиеВнешнимИБ.НайтиПоНаименованию("Номенклатура <-> Статьи доходов",,, Объект.База.ТипБД);
	
	Если НЕ ПравоДоступа("Изменение", Метаданные.РегистрыСведений.СоответствиеОбъектовТекущейИВнешнихИБ) Тогда
		ТолькоПросмотр = Истина;
	Конецесли;	
	
	СвойствоСтатья = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("Имя", "Статья");
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверкаЗаполнить(Команда)
	ПроверкаЗаполнитьНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПроверкаЗаполнитьНаСервере()
	
	Запрос = Новый Запрос;
	Запрос.Параметры.Вставить("База",                 Объект.База);
	Запрос.Параметры.Вставить("Настройка",            Объект.Настройка);
	Запрос.Параметры.Вставить("СвойствоСтатья",       СвойствоСтатья);
	Запрос.Параметры.Вставить("СвойствоНоменклатура", ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("Имя", "Номенклатура"));
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 10000
	|	Док.Ссылка КАК Документ,
	|	СвойствоСтатья.Значение КАК Статья,
	|	Рег.ОбъектТекущейИБ КАК СтатьяНовая,
	|	СвойствоНоменклатура.Значение КАК Номенклатура
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК Док
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДополнительныеСведения КАК СвойствоСтатья
	|		ПО Док.Ссылка = СвойствоСтатья.Объект
	|			И (СвойствоСтатья.Свойство = &СвойствоСтатья)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДополнительныеСведения КАК СвойствоНоменклатура
	|		ПО Док.Ссылка = СвойствоНоменклатура.Объект
	|			И (СвойствоНоменклатура.Свойство = &СвойствоНоменклатура)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеОбъектовТекущейИВнешнихИБ КАК Рег
	|		ПО (Рег.ИспользуемаяИБ = &База)
	|			И (Рег.НастройкаСоответствия = &Настройка)
	|			И ВЫРАЗИТЬ(СвойствоНоменклатура.Значение КАК Справочник.Номенклатура).Наименование = Рег.ОбъектВнешнейИБ
	|ГДЕ
	|	НЕ Док.ПометкаУдаления
	|	И ЕСТЬNULL(СвойствоСтатья.Значение, Неопределено) <> Рег.ОбъектТекущейИБ";
	
	ТЗ = Запрос.Выполнить().Выгрузить();
	ТаблицаПроверки.Загрузить(ТЗ);
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверкаИзменитьСтатью(Команда)
	
	ПроверкаИзменитьСтатьюНаСервере();
	Состояние("Статья изменена");
	
КонецПроцедуры

&НаСервере
Процедура ПроверкаИзменитьСтатьюНаСервере()
	
	Для каждого СтрокаТЗ из ТаблицаПроверки Цикл
		
		Запись = РегистрыСведений.ДополнительныеСведения.СоздатьМенеджерЗаписи();
		Запись.Объект   = СтрокаТЗ.Документ;
		Запись.Свойство = СвойствоСтатья;
		Запись.Значение = СтрокаТЗ.СтатьяНовая;
		Запись.Записать();
		
	КонецЦикла;	
	
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаПроверкиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ТекущиеДанные = ТаблицаПроверки.НайтиПоИдентификатору(ВыбраннаяСтрока);
	ПоказатьЗначение(, ТекущиеДанные.Документ);
	
КонецПроцедуры
